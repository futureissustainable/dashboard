# =============================================================================
# BIOBUILDS Daily Reddit Post & Comment Generator — v4.0
# =============================================================================
#
# Architecture:
#   Runs every weekday (Mon-Fri) at 01:00 UTC.
#   Generates 1 Reddit post in English that must resonate across all 3
#   markets (DACH, Romania, international) simultaneously.
#   Includes 3 comment recommendations for existing Reddit threads.
#   Output is committed directly to main in the output/reddit/ folder.
#
# SETUP:
#   1. Run `claude setup-token` locally -> copy the token
#   2. Repo -> Settings -> Secrets -> Actions -> New repository secret:
#      Name:  CLAUDE_CODE_OAUTH_TOKEN
#      Value: (paste token from step 1)
#   3. Place this file at: .github/workflows/daily-reddit-posts.yml
#   4. Merge to default branch (schedule only fires from default branch)
#   5. Test: Actions tab -> "Daily Reddit Posts" -> Run workflow
#
# SECURITY:
#   - Actions pinned to full 40-char commit SHAs
#   - Permissions: contents:write + id-token:write (no PR needed)
#   - OAuth token = high-value credential -> rotate every 60-90 days
#   - Trigger: schedule + workflow_dispatch only (no PR/fork triggers)
# =============================================================================

name: Daily Reddit Posts

on:
  schedule:
    # Every weekday (Mon-Fri) at 01:00 UTC (runs first)
    - cron: '0 1 * * 1-5'
  workflow_dispatch:                # manual trigger from Actions tab

permissions:
  contents: write
  id-token: write

# Prevent overlapping runs
concurrency:
  group: daily-reddit-posts
  cancel-in-progress: false

jobs:
  generate-and-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    defaults:
      run:
        working-directory: claude_automation

    steps:
      # --- Setup -----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Set today's date
        id: date
        run: echo "today=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Determine this week's content pillar
        id: pillar
        run: |
          # Rotate through 8 pillars based on ISO week number
          WEEK=$(date -u +%V)
          PILLARS=("Energy & Performance" "Cost & Finance" "Construction & Process" "Materials & Sustainability" "Regulations & Certification" "Living Experience" "Market Comparison" "Lifestyle & Design")
          INDEX=$(( (10#$WEEK - 1) % 8 ))
          echo "pillar=${PILLARS[$INDEX]}" >> "$GITHUB_OUTPUT"
          echo "This week's pillar: ${PILLARS[$INDEX]}"

      - name: Check for new feedback
        id: check_feedback
        run: |
          DIR="feedback/reddit"
          if [ -d "$DIR" ]; then
            # Count JSONs without "summarized": true
            NEW=0
            for f in "$DIR"/*.json; do
              [ -f "$f" ] || continue
              if ! jq -e '.summarized == true' "$f" >/dev/null 2>&1; then
                NEW=$((NEW + 1))
              fi
            done
            echo "new_count=$NEW" >> "$GITHUB_OUTPUT"
            [ "$NEW" -gt 0 ] && echo "has_new=true" >> "$GITHUB_OUTPUT" || echo "has_new=false" >> "$GITHUB_OUTPUT"
          else
            echo "new_count=0" >> "$GITHUB_OUTPUT"
            echo "has_new=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Summarize feedback
        if: steps.check_feedback.outputs.has_new == 'true'
        uses: anthropics/claude-code-action@01e756b34ef7a1447e9508f674143b07d20c2631
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are a feedback summarizer. Update the rolling feedback summary
            for the reddit platform.

            DO NOT run any git commands.

            Steps:
            1. Read claude_automation/feedback/reddit/SUMMARY.md if it exists
            2. List all .json files in claude_automation/feedback/reddit/
            3. Read each JSON file. SKIP any where "summarized" is true.
               If no unsummarized files exist, stop — do nothing.
            4. Update claude_automation/feedback/reddit/SUMMARY.md with this exact format:

            ## Reddit Feedback ({N} posts reviewed)

            ### Patterns to REPEAT
            - [pattern from high-scoring/approved posts] (seen Nx, avg score: X)

            ### Patterns to AVOID
            - [pattern from denied/low-scoring posts] (seen Nx)

            ### Recent notes
            - YYYY-MM-DD: status (score/100) — feedback text
            (keep last 10 entries max)

            Rules for updating:
            - Merge new feedback into existing patterns (increment counts)
            - Add new patterns if they don't exist yet
            - Keep "Recent notes" to last 10 entries, drop oldest
            - Be concise: each pattern should be one line
            - Preserve existing pattern counts and averages

            5. For each JSON you processed, update it: add "summarized": true
               to the JSON object and write it back.

          claude_args: |
            --max-turns 15
            --model claude-haiku-4-5-20251001
            --allowedTools "Read,Write,Edit,Glob,Grep"

      - name: Collect feedback summary
        id: feedback
        run: |
          SUMMARY_FILE="feedback/reddit/SUMMARY.md"
          if [ -f "$SUMMARY_FILE" ]; then
            # Read summary, cap at 2000 chars
            CONTENT=$(head -c 2000 "$SUMMARY_FILE")
            echo "summary<<EOF" >> "$GITHUB_OUTPUT"
            echo "$CONTENT" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "has_feedback=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_feedback=false" >> "$GITHUB_OUTPUT"
            echo "summary=No feedback yet" >> "$GITHUB_OUTPUT"
          fi

      # --- Generate single post (all markets) ------------------------------
      - name: Generate Reddit post (all markets)
        uses: anthropics/claude-code-action@01e756b34ef7a1447e9508f674143b07d20c2631
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are a Reddit post generator for the BioBuilds content strategy.
            Today's date: ${{ steps.date.outputs.today }}
            This week's content pillar: ${{ steps.pillar.outputs.pillar }}

            ===============================================================
            RECENT FEEDBACK ON PAST REDDIT POSTS (learn from this)
            ===============================================================
            ${{ steps.feedback.outputs.summary }}

            Apply these lessons: repeat what scored high, fix what was denied
            or scored low. This is non-negotiable.

            DO NOT run any git commands.
            DO NOT create branches, commits, or pull requests.

            ===============================================================
            THE CORE CHALLENGE
            ===============================================================

            You must write ONE Reddit post in ENGLISH that simultaneously
            serves BioBuilds' two primary markets and broader European
            audience:
            - DACH (Germany, Austria, Switzerland) — primary market
            - Romania — young families (30-45), ~70% IT industry, rest
              entrepreneurs or higher-paying professions. NOT luxury.
            - International (rest of EU) — secondary reach

            The post must feel like a real person's experience or research
            that naturally covers data relevant to multiple European markets.
            A post about "comparing modular home manufacturers across Europe"
            or "my experience building a Passivhaus" naturally serves all
            audiences without feeling forced.

            HOW TO DO THIS:
            - Write as someone with a pan-European perspective (expat, researcher,
              investor comparing options across countries, someone who built
              in one country and is comparing to others)
            - Include data points from multiple markets naturally:
              * DACH angle: German prices (EUR 4,800/m2), KfW funding, Fertighaus context
              * Romania angle: manufacturing origin, EUR 1,676/m2, certification data
              * EU-wide: Passivhaus standards, energy prices, modular industry trends
            - The persona should have a reason to discuss multiple markets
            - Don't force all 3 markets in every paragraph; weave them naturally

            ===============================================================
            AVAILABLE TOOLS (use ONLY these)
            ===============================================================
            You have ONLY these tools: Read, Write, Edit, Glob, Grep,
            WebSearch, WebFetch.

            Bash, curl, shell commands are NOT available.

            To search the internet: use WebSearch
            To fetch a specific URL: use WebFetch
            To find Reddit posts: use WebSearch with site:reddit.com queries

            ===============================================================
            PHASE 1 — READ ALL INSTRUCTIONS (mandatory, do not skip)
            ===============================================================

            1. Read claude_automation/CLAUDE.md — project rules and constraints
            2. Read claude_automation/docs/reddit/REDDIT_SOUL.md — complete persona, writing rules,
               and UNIFIED 9-SUB ROTATION POOL
            3. Read claude_automation/docs/reddit/REDDIT_REPORT_SEO.md — SEO strategy data
            4. Read claude_automation/docs/reddit/REDDIT_REPORT_AI.md — AI citation strategy
            5. Read claude_automation/docs/reddit/REDDIT_PLAYBOOK.md — master strategy,
               positioning, post templates, compliance rules, data anchors
            6. Read claude_automation/.agents/skills/seo-audit/references/ai-writing-detection.md
            7. Read claude_automation/.agents/skills/seo-audit/references/aeo-geo-patterns.md
            8. Read claude_automation/docs/company/biobuilds-company-overview.md

            ===============================================================
            PHASE 2 — CHECK EXISTING POSTS (avoid duplication + rotation)
            ===============================================================

            9. List all files in claude_automation/output/reddit/ directory
            10. Read the last 5 posts (if they exist) and extract:
                - The "subreddit:" field from each post's YAML frontmatter
                - What topics were already covered
                - What personas were used
                - What pillar each post targeted
            11. Build a BLOCKED LIST of subreddits used in the last 3 weeks
                — you CANNOT use any of these
            12. Make sure your post covers NEW ground

            ===============================================================
            PHASE 3 — RESEARCH (get real, current data across markets)
            ===============================================================

            13. Use WebSearch to find 3-5 current data points relevant to
                this week's pillar. Search for cross-market data:
                - European energy prices or housing cost comparisons
                - Passivhaus certification stats across countries
                - Modular construction trends EU-wide
                - KfW funding rates (DACH angle)
                - Romanian/Eastern European construction developments
            14. Cross-reference with data from the strategy reports
            15. Find real competitor data from multiple markets

            ===============================================================
            PHASE 4 — WRITE THE POST (English, all markets, 8+ data points)
            ===============================================================

            16. Pick a subreddit from the unified 9-sub pool in REDDIT_SOUL.md
                - Do NOT use any subreddit from the blocked list
            17. Create a persona with a natural reason to discuss multiple
                European markets (expat, researcher, investor, builder who
                sourced from Eastern Europe, etc.)
            18. Write the full Reddit post following ALL rules in REDDIT_SOUL.md:
                - Natural, human-sounding English writing
                - Include AT LEAST 8 specific data points with numbers
                - Include data from multiple markets woven naturally
                - BioBuilds as ONE option among several (or not at all)
                - Include honest pros and cons
                - End with TL;DR (include 3-5 numeric anchors)
                - NO AI writing tells
            19. Create a realistic image_idea in the frontmatter. This must be
                an ORIGINAL image concept you propose (NOT from the claude_automation/Creatives/
                catalog). Reddit posts need unique, context-appropriate visuals
                like infographics, comparison charts, maps, or photos that
                match the persona's story. Describe what the image should show,
                its style, and why it fits the post.
                NEVER use or reference files from the claude_automation/Creatives/ folder.
            20. Save to claude_automation/output/reddit/ as:
                ${{ steps.date.outputs.today }}_[slug].md

            ===============================================================
            PHASE 5 — COMMENT RECOMMENDATIONS (trust builder)
            ===============================================================

            21. Use WebSearch to find 3 EXISTING Reddit posts where a
                helpful, data-rich comment would fit naturally
            22. For each, write a recommended comment that:
                - Adds genuine value (data, experience, checklist)
                - Does NOT mention BioBuilds (pure value, trust first)
                - Includes at least 2 specific data points
            23. Append the 3 comment recommendations to the post file

            ===============================================================
            RULES (violations = failure)
            ===============================================================
            - NEVER use Bash, curl, or shell commands
            - NEVER run git commands
            - NEVER sound like an advertisement
            - NEVER write as a BioBuilds employee
            - NEVER use AI-detectable writing patterns
            - NEVER use images from the claude_automation/Creatives/ catalog (always propose original image ideas)
            - NEVER duplicate a topic or reuse a blocked subreddit
            - ALWAYS write in English
            - ALWAYS include data relevant to multiple markets
            - ALWAYS pick from the unified 9-sub pool in REDDIT_SOUL.md
            - ALWAYS include YAML frontmatter per REDDIT_SOUL.md
            - ALWAYS include at least 8 specific data points
            - ALWAYS include a TL;DR with 3-5 numeric anchors
            - ALWAYS include 3 comment recommendations with real Reddit URLs

          claude_args: |
            --max-turns 45
            --model claude-opus-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      # --- Commit directly to main -----------------------------------------
      - name: Check for changes
        id: changes
        run: |
          STATUS="$(git status --porcelain output/reddit/ feedback/reddit/)"
          if [ -z "$STATUS" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "::warning::No new post generated"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected:"
            echo "$STATUS"
          fi

      - name: Commit and push to main
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add output/reddit/ feedback/reddit/

          TODAY="${{ steps.date.outputs.today }}"
          PILLAR="${{ steps.pillar.outputs.pillar }}"

          git commit -m "reddit: ${TODAY} [${PILLAR}]"

          # Pull-rebase in case another workflow pushed first
          git pull --rebase origin ${{ github.event.repository.default_branch }}
          git push origin HEAD:${{ github.event.repository.default_branch }}
