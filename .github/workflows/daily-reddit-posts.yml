# =============================================================================
# BIOBUILDS Reddit Hook Generator (Phase 1) — v5.0
# =============================================================================
#
# Architecture:
#   Runs every weekday (Mon-Fri) at 01:00 UTC.
#   Generates 5 wildly different hook/angle ideas for Reddit.
#   Output is committed directly to main in the hooks/reddit/ folder.
#   Human reviews hooks in dashboard, then triggers Phase 2 (post writing).
#
# SETUP:
#   1. Run `claude setup-token` locally -> copy the token
#   2. Repo -> Settings -> Secrets -> Actions -> New repository secret:
#      Name:  CLAUDE_CODE_OAUTH_TOKEN
#      Value: (paste token from step 1)
#   3. Place this file at: .github/workflows/daily-reddit-posts.yml
#   4. Merge to default branch (schedule only fires from default branch)
#   5. Test: Actions tab -> "Daily Reddit Posts" -> Run workflow
#
# SECURITY:
#   - Actions pinned to full 40-char commit SHAs
#   - Permissions: contents:write + id-token:write (no PR needed)
#   - OAuth token = high-value credential -> rotate every 60-90 days
#   - Trigger: schedule + workflow_dispatch only (no PR/fork triggers)
# =============================================================================

name: Daily Reddit Posts

on:
  schedule:
    # Every weekday (Mon-Fri) at 01:00 UTC (runs first)
    - cron: '0 1 * * 1-5'
  workflow_dispatch:                # manual trigger from Actions tab

permissions:
  contents: write
  id-token: write

# Prevent overlapping runs
concurrency:
  group: daily-reddit-posts
  cancel-in-progress: false

jobs:
  generate-and-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    defaults:
      run:
        working-directory: claude_automation

    steps:
      # --- Setup -----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 1
          ref: ${{ github.event.repository.default_branch }}

      - name: Set today's date
        id: date
        run: echo "today=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Determine this week's content pillar
        id: pillar
        run: |
          # Rotate through 8 pillars based on ISO week number
          WEEK=$(date -u +%V)
          PILLARS=("Energy & Performance" "Cost & Finance" "Construction & Process" "Materials & Sustainability" "Regulations & Certification" "Living Experience" "Market Comparison" "Lifestyle & Design")
          INDEX=$(( (10#$WEEK - 1) % 8 ))
          echo "pillar=${PILLARS[$INDEX]}" >> "$GITHUB_OUTPUT"
          echo "This week's pillar: ${PILLARS[$INDEX]}"

      - name: Check for existing unreviewed hooks
        id: check_hooks
        run: |
          HOOKS_FILE="hooks/reddit/${{ steps.date.outputs.today }}.json"
          if [ -f "$HOOKS_FILE" ]; then
            STATUS=$(python3 -c "import json; print(json.load(open('$HOOKS_FILE'))['status'])" 2>/dev/null || echo "unknown")
            if [ "$STATUS" = "pending" ]; then
              echo "skip=true" >> "$GITHUB_OUTPUT"
              echo "::warning::Hooks already exist for today and haven't been reviewed yet"
            else
              echo "skip=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for new feedback
        if: steps.check_hooks.outputs.skip != 'true'
        id: check_feedback
        run: |
          DIR="feedback/reddit"
          if [ -d "$DIR" ]; then
            # Count JSONs without "summarized": true
            NEW=0
            for f in "$DIR"/*.json; do
              [ -f "$f" ] || continue
              if ! jq -e '.summarized == true' "$f" >/dev/null 2>&1; then
                NEW=$((NEW + 1))
              fi
            done
            echo "new_count=$NEW" >> "$GITHUB_OUTPUT"
            [ "$NEW" -gt 0 ] && echo "has_new=true" >> "$GITHUB_OUTPUT" || echo "has_new=false" >> "$GITHUB_OUTPUT"
          else
            echo "new_count=0" >> "$GITHUB_OUTPUT"
            echo "has_new=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Summarize feedback
        if: steps.check_hooks.outputs.skip != 'true' && steps.check_feedback.outputs.has_new == 'true'
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are a feedback summarizer. Update the rolling feedback summary
            for the reddit platform.

            DO NOT run any git commands.

            Steps:
            1. Read claude_automation/feedback/reddit/SUMMARY.md if it exists
            2. List all .json files in claude_automation/feedback/reddit/
            3. Read each JSON file. SKIP any where "summarized" is true.
               If no unsummarized files exist, stop — do nothing.
            4. Update claude_automation/feedback/reddit/SUMMARY.md with this exact format:

            ## Reddit Feedback ({N} posts reviewed)

            ### Patterns to REPEAT
            - [pattern from high-scoring/approved posts] (seen Nx, avg score: X)

            ### Patterns to AVOID
            - [pattern from denied/low-scoring posts] (seen Nx)

            ### Engagement Winners (real post-publish data)
            - YYYY-MM-DD: [key metrics] — [what pattern/angle was used] — [notes]
            (only include posts that have "engagement" data in their JSON)

            ### Recent notes
            - YYYY-MM-DD: status (score/100) — feedback text
            (keep last 10 entries max)

            Rules for updating:
            - Merge new feedback into existing patterns (increment counts)
            - Add new patterns if they don't exist yet
            - If a JSON has "engagement" data, extract the winning pattern
              and add it to "Engagement Winners." This is the highest-value
              signal — real post-publish performance data.
            - Keep "Recent notes" to last 10 entries, drop oldest
            - Be concise: each pattern should be one line
            - Preserve existing pattern counts and averages

            6. LEVER PERFORMANCE TRACKING:
               For each feedback JSON that has BOTH "psychological_lever" AND
               ("engagement" data OR a score):
               - Read existing claude_automation/hooks/reddit/lever-performance.json
               - Merge: lever → { times_used, avg_review_score, avg_saves,
                 avg_shares, trend, best_hook, worst_hook }
               - Write updated lever-performance.json

            5. For each JSON you processed, update it: add "summarized": true
               to the JSON object and write it back.

          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep"

      - name: Collect feedback summary
        if: steps.check_hooks.outputs.skip != 'true'
        id: feedback
        run: |
          SUMMARY_FILE="feedback/reddit/SUMMARY.md"
          if [ -f "$SUMMARY_FILE" ]; then
            # Read summary, cap at 2000 chars
            CONTENT=$(head -c 2000 "$SUMMARY_FILE")
            DELIM="FEEDBACK_SUMMARY_$(date +%s)"
            echo "summary<<${DELIM}" >> "$GITHUB_OUTPUT"
            echo "$CONTENT" >> "$GITHUB_OUTPUT"
            echo "${DELIM}" >> "$GITHUB_OUTPUT"
            echo "has_feedback=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_feedback=false" >> "$GITHUB_OUTPUT"
            echo "summary=No feedback yet" >> "$GITHUB_OUTPUT"
          fi

      # --- Generate 5 hooks (Phase 1) -------------------------------------
      - name: Generate 5 Reddit hooks
        if: steps.check_hooks.outputs.skip != 'true'
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are a Reddit hook generator for the BioBuilds content strategy.
            Today's date: ${{ steps.date.outputs.today }}
            This week's content pillar: ${{ steps.pillar.outputs.pillar }}

            ===============================================================
            RECENT FEEDBACK ON PAST REDDIT POSTS (learn from this)
            ===============================================================
            ${{ steps.feedback.outputs.summary }}

            Apply these lessons: repeat what scored high, fix what was denied
            or scored low. This is non-negotiable.

            DO NOT run any git commands.
            DO NOT create branches, commits, or pull requests.

            ===============================================================
            YOUR TASK: Generate exactly 5 hook ideas
            ===============================================================

            Instead of writing a full post, generate 5 wildly different
            hook/angle ideas. Each must target a DIFFERENT psychological
            lever, audience segment, or content approach. Maximum diversity.

            ===============================================================
            PHASE 1 — READ STRATEGY DOCS (mandatory)
            ===============================================================

            1. Read claude_automation/CLAUDE.md
            2. Read claude_automation/docs/reddit/REDDIT_SOUL.md
               — especially "Learned Rules from Feedback" and the
               UNIFIED 9-SUB ROTATION POOL
            3. Read claude_automation/docs/reddit/REDDIT_PLAYBOOK.md
            4. Read claude_automation/docs/reddit/REDDIT_REPORT_SEO.md
            5. Read claude_automation/docs/reddit/REDDIT_REPORT_AI.md
            6. Read claude_automation/.agents/skills/seo-audit/references/ai-writing-detection.md
            7. Read claude_automation/.agents/skills/seo-audit/references/aeo-geo-patterns.md
            8. Read claude_automation/docs/company/biobuilds-company-overview.md
            9. Read claude_automation/docs/company/BIOBUILDS_BRAND_VOICE_MANIFESTO.md
            10. Read claude_automation/hooks/reddit/examples.json if it exists
                — these are HUMAN-WRITTEN example hooks (gold standard)
                — study their hook_text, angle, lever, and notes carefully
                — match their quality, specificity, and tone
                — do NOT copy them verbatim, but use them as inspiration
            11. Read claude_automation/hooks/reddit/lever-performance.json if it exists
                — shows which psychological levers ACTUALLY perform post-publish
                — weight your 5 hooks toward high-performing levers
                — always include 1 hook using an untested or underperforming lever
                — if a lever has avg_review_score < 30, avoid unless genuinely different

            ===============================================================
            PHASE 2 — CHECK EXISTING (avoid duplication)
            ===============================================================

            10. List claude_automation/output/reddit/ — read last 5 posts
            11. List claude_automation/hooks/reddit/ — read recent hooks
            12. Identify which angles, levers, subreddits, and topics are
                overused

            ===============================================================
            PHASE 3 — RESEARCH (fresh data for hooks)
            ===============================================================

            13. Use WebSearch to find 3-5 current data points relevant to
                this week's pillar across DACH + Romania + EU
            14. Find surprising numbers, contrasts, or facts that could
                anchor different hooks

            ===============================================================
            PHASE 4 — GENERATE 5 HOOKS
            ===============================================================

            For each hook, provide ALL of these fields:
            - id: "h01" through "h05"
            - hook_text: The actual title/opening line (complete, usable)
            - angle: 1-2 sentence description of the full post approach
            - psychological_lever: One of these categories:
              cost savings, modernity contradiction, time value,
              health/indoor environment, social comparison, material purity,
              lifetime cost, sleep/performance, parental fear, industry failure,
              humor/absurdity, regulation/compliance, investment/roi,
              silence/privacy, summer heat, confrontation/material fight,
              origin story, trust/legitimacy
            - target_audience: Specific segment this hook targets
            - differentiation: Why different from ALL other 4 hooks
            - platform_meta: { "subreddit": "<from 9-sub pool in REDDIT_SOUL.md>", "persona_type": "<expat|researcher|builder|investor|etc>", "mentions_biobuilds": "true|false" }

            RULES FOR HOOKS:
            - Each hook MUST use a DIFFERENT psychological lever
            - Each hook must suggest a subreddit from the unified 9-sub
              pool in REDDIT_SOUL.md
            - At least 1 hook must lead with a specific number or EUR amount
            - At least 1 hook must include DACH-specific data
            - At least 1 hook must include Romania/Eastern Europe angle
            - Humor is welcome but not required for every batch
            - If claude_automation/hooks/reddit/lever-performance.json exists,
              bias toward high-performing levers but always include 1 experimental
              lever not yet tested
            - No two hooks should feel like variations of the same idea
            - Each hook must be genuinely different in TONE, not just topic
            - Write each hook_text as if it were the actual Reddit post title
            - Apply all learned rules from feedback (denied patterns = banned)
            - Hooks must pass the "would I click this?" test
            - platform_meta.mentions_biobuilds must be "true" or "false"
              (string, not boolean) — most hooks should be "false"

            ===============================================================
            PHASE 5 — SAVE AS JSON
            ===============================================================

            Save to claude_automation/hooks/reddit/${{ steps.date.outputs.today }}.json
            as a valid JSON object:

            {
              "platform": "reddit",
              "date": "${{ steps.date.outputs.today }}",
              "pillar": "${{ steps.pillar.outputs.pillar }}",
              "generated_at": "<ISO timestamp>",
              "status": "pending",
              "hooks": [ ... 5 hook objects ... ]
            }

            ===============================================================
            RULES (violations = failure)
            ===============================================================
            - NEVER use Bash, curl, or shell commands
            - NEVER run git commands
            - NEVER repeat an angle already in recent hooks or posts
            - NEVER use AI-detectable writing patterns in hook_text
            - NEVER frame BioBuilds as building offices or commercial spaces
            - ALWAYS generate exactly 5 hooks
            - ALWAYS use different psychological levers
            - ALWAYS write hook_text in English
            - ALWAYS pick subreddits from the unified 9-sub pool in REDDIT_SOUL.md

          claude_args: |
            --max-turns 25
            --model claude-opus-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      # --- Commit directly to main -----------------------------------------
      - name: Check for changes
        if: steps.check_hooks.outputs.skip != 'true'
        id: changes
        run: |
          PATHS="hooks/reddit/"
          [ -d "feedback/reddit" ] && PATHS="$PATHS feedback/reddit/"
          STATUS="$(git status --porcelain $PATHS)"
          if [ -z "$STATUS" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "::warning::No new Reddit hooks generated"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected:"
            echo "$STATUS"
          fi

      - name: Commit and push to main
        if: steps.check_hooks.outputs.skip != 'true' && steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add hooks/reddit/
          git add feedback/reddit/ 2>/dev/null || true

          TODAY="${{ steps.date.outputs.today }}"
          PILLAR="${{ steps.pillar.outputs.pillar }}"

          git commit -m "hooks: reddit ${TODAY} [${PILLAR}]"

          # Pull-rebase in case another workflow pushed first, with retry
          for attempt in 1 2 3; do
            git pull --rebase origin ${{ github.event.repository.default_branch }} && \
            git push origin HEAD:${{ github.event.repository.default_branch }} && break
            echo "Push attempt $attempt failed, retrying in $((attempt * 2))s..."
            sleep $((attempt * 2))
          done
