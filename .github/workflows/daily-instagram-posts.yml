# =============================================================================
# BIOBUILDS Instagram Hook Generator (Phase 1) — v3.0
# =============================================================================
#
# Architecture:
#   Runs every weekday (Mon-Fri) at 02:00 UTC.
#   Generates 10 wildly different hook/angle ideas for Instagram.
#   Output is committed directly to main in the hooks/instagram/ folder.
#   Human reviews hooks in dashboard, then triggers Phase 2 (caption writing).
#
# SETUP:
#   1. Run `claude setup-token` locally -> copy the token
#   2. Repo -> Settings -> Secrets -> Actions -> New repository secret:
#      Name:  CLAUDE_CODE_OAUTH_TOKEN
#      Value: (paste token from step 1)
#   3. Place this file at: .github/workflows/daily-instagram-posts.yml
#   4. Merge to default branch (schedule only fires from default branch)
#   5. Test: Actions tab -> "Daily Instagram Posts" -> Run workflow
#
# SECURITY:
#   - Actions pinned to full 40-char commit SHAs
#   - Permissions: contents:write + id-token:write (no PR needed)
#   - OAuth token = high-value credential -> rotate every 60-90 days
#   - Trigger: schedule + workflow_dispatch only (no PR/fork triggers)
# =============================================================================

name: Daily Instagram Posts

on:
  schedule:
    # Every weekday (Mon-Fri) at 02:00 UTC (staggered to avoid push conflicts)
    - cron: '0 2 * * 1-5'
  workflow_dispatch:                # manual trigger from Actions tab

permissions:
  contents: write
  id-token: write

# Prevent overlapping runs
concurrency:
  group: daily-instagram-posts
  cancel-in-progress: false

jobs:
  generate-and-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    defaults:
      run:
        working-directory: claude_automation

    steps:
      # --- Setup -----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 1
          ref: ${{ github.event.repository.default_branch }}

      - name: Set today's date
        id: date
        run: echo "today=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Determine this week's content pillar
        id: pillar
        run: |
          # Rotate through 8 pillars based on ISO week number
          WEEK=$(date -u +%V)
          PILLARS=("Energy & Performance" "Cost & Finance" "Construction & Process" "Materials & Sustainability" "Regulations & Certification" "Living Experience" "Market Comparison" "Lifestyle & Design")
          INDEX=$(( (10#$WEEK - 1) % 8 ))
          echo "pillar=${PILLARS[$INDEX]}" >> "$GITHUB_OUTPUT"
          echo "This week's pillar: ${PILLARS[$INDEX]}"

      - name: Check for existing unreviewed hooks
        id: check_hooks
        run: |
          HOOKS_FILE="hooks/instagram/${{ steps.date.outputs.today }}.json"
          if [ -f "$HOOKS_FILE" ]; then
            STATUS=$(python3 -c "import json; print(json.load(open('$HOOKS_FILE'))['status'])" 2>/dev/null || echo "unknown")
            if [ "$STATUS" = "pending" ]; then
              echo "skip=true" >> "$GITHUB_OUTPUT"
              echo "::warning::Hooks already exist for today and haven't been reviewed yet"
            else
              echo "skip=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for new feedback
        if: steps.check_hooks.outputs.skip != 'true'
        id: check_feedback
        run: |
          DIR="feedback/instagram"
          if [ -d "$DIR" ]; then
            NEW=0
            for f in "$DIR"/*.json; do
              [ -f "$f" ] || continue
              if ! jq -e '.summarized == true' "$f" >/dev/null 2>&1; then
                NEW=$((NEW + 1))
              fi
            done
            echo "new_count=$NEW" >> "$GITHUB_OUTPUT"
            [ "$NEW" -gt 0 ] && echo "has_new=true" >> "$GITHUB_OUTPUT" || echo "has_new=false" >> "$GITHUB_OUTPUT"
          else
            echo "new_count=0" >> "$GITHUB_OUTPUT"
            echo "has_new=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Summarize feedback
        if: steps.check_hooks.outputs.skip != 'true' && steps.check_feedback.outputs.has_new == 'true'
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are a feedback summarizer. Update the rolling feedback summary
            for the instagram platform.

            DO NOT run any git commands.

            Steps:
            1. Read claude_automation/feedback/instagram/SUMMARY.md if it exists
            2. List all .json files in claude_automation/feedback/instagram/
            3. Read each JSON file. SKIP any where "summarized" is true.
               If no unsummarized files exist, stop — do nothing.
            4. Update claude_automation/feedback/instagram/SUMMARY.md with this exact format:

            ## Instagram Feedback ({N} posts reviewed)

            ### Patterns to REPEAT
            - [pattern from high-scoring/approved posts] (seen Nx, avg score: X)

            ### Patterns to AVOID
            - [pattern from denied/low-scoring posts] (seen Nx)

            ### Engagement Winners (real post-publish data)
            - YYYY-MM-DD: [key metrics] — [what pattern/angle was used] — [notes]
            (only include posts that have "engagement" data in their JSON)

            ### Recent notes
            - YYYY-MM-DD: status (score/100) — feedback text
            (keep last 10 entries max)

            Rules for updating:
            - Merge new feedback into existing patterns (increment counts)
            - Add new patterns if they don't exist yet
            - If a JSON has "engagement" data, extract the winning pattern
              and add it to "Engagement Winners." This is the highest-value
              signal — real post-publish performance data.
            - Keep "Recent notes" to last 10 entries, drop oldest
            - Be concise: each pattern should be one line
            - Preserve existing pattern counts and averages

            6. LEVER PERFORMANCE TRACKING:
               For each feedback JSON that has BOTH "psychological_lever" AND
               ("engagement" data OR a score):
               - Read existing claude_automation/hooks/instagram/lever-performance.json
               - Merge: lever → { times_used, avg_review_score, avg_saves,
                 avg_shares, trend, best_hook, worst_hook }
               - Write updated lever-performance.json

            5. For each JSON you processed, update it: add "summarized": true
               to the JSON object and write it back.

          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep"

      - name: Collect feedback summary
        if: steps.check_hooks.outputs.skip != 'true'
        id: feedback
        run: |
          SUMMARY_FILE="feedback/instagram/SUMMARY.md"
          if [ -f "$SUMMARY_FILE" ]; then
            CONTENT=$(head -c 2000 "$SUMMARY_FILE")
            DELIM="FEEDBACK_SUMMARY_$(date +%s)"
            echo "summary<<${DELIM}" >> "$GITHUB_OUTPUT"
            echo "$CONTENT" >> "$GITHUB_OUTPUT"
            echo "${DELIM}" >> "$GITHUB_OUTPUT"
            echo "has_feedback=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_feedback=false" >> "$GITHUB_OUTPUT"
            echo "summary=No feedback yet" >> "$GITHUB_OUTPUT"
          fi

      - name: List available creatives
        if: steps.check_hooks.outputs.skip != 'true'
        id: creatives
        run: |
          # Check for actual media files (not just CATALOG.md and .gitkeep)
          MEDIA_FILES=$(find Creatives/ -type f \
            \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \
               -o -iname '*.webp' -o -iname '*.mp4' -o -iname '*.mov' \
               -o -iname '*.gif' \) 2>/dev/null | head -50)

          if [ -n "$MEDIA_FILES" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
            DELIM="CREATIVES_LIST_$(date +%s)"
            echo "list<<${DELIM}" >> "$GITHUB_OUTPUT"
            echo "$MEDIA_FILES" >> "$GITHUB_OUTPUT"
            echo "${DELIM}" >> "$GITHUB_OUTPUT"

            # Include catalog if it exists
            if [ -f "Creatives/CATALOG.md" ]; then
              echo "has_catalog=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_catalog=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "list=No creatives available" >> "$GITHUB_OUTPUT"
            echo "has_catalog=false" >> "$GITHUB_OUTPUT"
          fi

      # --- Rate creatives (pick highest potential) --------------------------
      - name: Rate creatives for Instagram
        if: steps.check_hooks.outputs.skip != 'true' && steps.creatives.outputs.available == 'true' && steps.creatives.outputs.has_catalog == 'true'
        id: rate_creatives
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are a creative asset analyst for BioBuilds' Instagram content.
            Today's date: ${{ steps.date.outputs.today }}
            This week's content pillar: ${{ steps.pillar.outputs.pillar }}

            Your job: rate every available creative 0-100 for how well it would
            perform on Instagram this week, given the current pillar.

            DO NOT run any git commands.

            Steps:
            1. Read claude_automation/Creatives/CATALOG.md for descriptions and
               status of each creative asset
            2. Read claude_automation/docs/instagram/INSTAGRAM_PLAYBOOK.md for what
               visuals and formats perform best on Instagram
            3. Read claude_automation/docs/instagram/INSTAGRAM_SOUL.md for the
               proven visual formula and visual rules
            4. Read claude_automation/docs/instagram/instagram-past-posts.md and study
               which visuals drove the highest engagement. What creative styles
               correlated with top performers? What visual killed engagement?
            5. List files in claude_automation/output/instagram/ and read the last 5
               posts to see which creatives were already used recently

            Now rate EVERY creative in the catalog that is AVAILABLE for Instagram.
            Available statuses: [available], [USED ON LINKEDIN], [REQUEST USE LINKEDIN]
            Skip: [reserved], [USED ON INSTA], [USED ON BOTH], [REQUEST USE INSTA]

            For each available creative, score 0-100 considering:
            - How well does it match this week's pillar (${{ steps.pillar.outputs.pillar }})?
            - Does it follow the proven visual formula? (Winter + warm glow + nature + human)
            - Would it stop the scroll on Instagram specifically?
            - Is it fresh (not recently used on Instagram)?
            - Would someone DM this image to their partner? (the "send test")
            - Does it create emotional contrast?

            Write your ratings to claude_automation/.creative-ratings-instagram.md
            in this exact format:

            # Creative Ratings — Instagram — ${{ steps.date.outputs.today }}
            Pillar: ${{ steps.pillar.outputs.pillar }}

            | Score | Creative | Reason |
            |-------|----------|--------|
            | 95 | filename1.jpg | One-line reason |
            | 82 | filename2.jpg | One-line reason |

            Sort by score DESCENDING. Top creative = best match for today's post.

          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep"

      - name: Collect creative ratings
        if: steps.check_hooks.outputs.skip != 'true'
        id: creative_ratings
        run: |
          RATINGS_FILE=".creative-ratings-instagram.md"
          if [ -f "$RATINGS_FILE" ]; then
            CONTENT=$(head -c 3000 "$RATINGS_FILE")
            DELIM="CREATIVE_RATINGS_$(date +%s)"
            echo "ratings<<${DELIM}" >> "$GITHUB_OUTPUT"
            echo "$CONTENT" >> "$GITHUB_OUTPUT"
            echo "${DELIM}" >> "$GITHUB_OUTPUT"
            echo "has_ratings=true" >> "$GITHUB_OUTPUT"
            rm -f "$RATINGS_FILE"
          else
            echo "has_ratings=false" >> "$GITHUB_OUTPUT"
            echo "ratings=No creative ratings available" >> "$GITHUB_OUTPUT"
          fi

      # --- Pattern innovation (analyze what works, propose experiment) ------
      - name: Analyze winning patterns and propose experiment
        if: steps.check_hooks.outputs.skip != 'true'
        id: innovation
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are a content strategist analyzing past post performance to
            find winning patterns and propose experiments for Instagram.
            Today's date: ${{ steps.date.outputs.today }}
            This week's pillar: ${{ steps.pillar.outputs.pillar }}

            DO NOT run any git commands.

            Steps:
            1. Read claude_automation/docs/instagram/instagram-past-posts.md
               — this has 62 real posts with likes, comments, shares, saves,
               reach, follows, image descriptions, and full captions
            2. Read claude_automation/feedback/instagram/SUMMARY.md if it exists
            3. Read claude_automation/docs/instagram/INSTAGRAM_SOUL.md
               — focus on "Learned Rules from Feedback" section
            4. List files in claude_automation/output/instagram/ and read the
               last 5 generated captions
            5. Read all .json files in claude_automation/feedback/instagram/
               — look for any with "engagement" data (real post-publish metrics)
            6. Read claude_automation/docs/company/BIOBUILDS_BRAND_VOICE_MANIFESTO.md
               — use this movement/story psychology lens when analyzing which
               patterns work and proposing today's experiment

            ANALYSIS:
            - Rank top 5 past posts by saves (strongest purchase-intent signal),
              then by shares (DM sends = Instagram's #1 algorithm signal)
            - For each: identify the SPECIFIC pattern that made it work
              (not vague — be precise about visual + caption combo)
            - Cross-reference with denied patterns
            - Note: static images get 4x more follows than reels based on
              past data. Factor this into experiment design.
            - If engagement data exists in feedback JSONs, weight those
              insights highest — that's real post-publish performance

            Write output to claude_automation/.pattern-innovation-instagram.md:

            ## Winning Patterns (from real data)
            1. [Pattern] — Evidence: [Post title, metrics] — Why: [reason]
            2. [Pattern] — Evidence: [Post title, metrics] — Why: [reason]
            3. [Pattern] — Evidence: [Post title, metrics] — Why: [reason]

            ## Today's Experiment
            [One specific technique/angle/format to test that hasn't been
            tried in the last 5 generated captions. Be creative. The best
            Instagram posts make someone screenshot and DM it to their partner.]
            Hypothesis: [Why this should work, based on patterns above]
            How to measure: [saves and shares are the key signals]

            ## Avoid Today
            - [Specific anti-pattern from denied posts or low performers]

          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep"

      - name: Collect innovation brief
        if: steps.check_hooks.outputs.skip != 'true'
        id: innovation_brief
        run: |
          BRIEF_FILE=".pattern-innovation-instagram.md"
          if [ -f "$BRIEF_FILE" ]; then
            CONTENT=$(head -c 3000 "$BRIEF_FILE")
            DELIM="INNOVATION_BRIEF_$(date +%s)"
            echo "brief<<${DELIM}" >> "$GITHUB_OUTPUT"
            echo "$CONTENT" >> "$GITHUB_OUTPUT"
            echo "${DELIM}" >> "$GITHUB_OUTPUT"
            rm -f "$BRIEF_FILE"
          else
            echo "brief=No innovation brief available" >> "$GITHUB_OUTPUT"
          fi

      # --- Generate 10 hooks (Phase 1) -------------------------------------
      - name: Generate 5 Instagram hooks
        if: steps.check_hooks.outputs.skip != 'true'
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are an Instagram hook generator for the BioBuilds content strategy.
            Today's date: ${{ steps.date.outputs.today }}
            This week's content pillar: ${{ steps.pillar.outputs.pillar }}

            ===============================================================
            CREATIVE RATINGS (available visuals, pre-analyzed)
            ===============================================================
            ${{ steps.creative_ratings.outputs.ratings }}

            ===============================================================
            INNOVATION BRIEF (winning patterns + today's experiment)
            ===============================================================
            ${{ steps.innovation_brief.outputs.brief }}

            ===============================================================
            RECENT FEEDBACK ON PAST INSTAGRAM POSTS
            ===============================================================
            ${{ steps.feedback.outputs.summary }}

            DO NOT run any git commands.
            DO NOT create branches, commits, or pull requests.

            ===============================================================
            YOUR TASK: Generate exactly 5 hook ideas
            ===============================================================

            Instead of writing a full caption, generate 5 wildly different
            hook/angle ideas. Each must target a DIFFERENT psychological
            lever, audience segment, or content approach. Maximum diversity.

            ===============================================================
            PHASE 1 — READ STRATEGY DOCS (mandatory)
            ===============================================================

            1. Read claude_automation/CLAUDE.md
            2. Read claude_automation/docs/instagram/INSTAGRAM_SOUL.md
               — especially "Learned Rules from Feedback"
            3. Read claude_automation/docs/instagram/INSTAGRAM_PLAYBOOK.md
            4. Read claude_automation/docs/instagram/instagram-past-posts.md
               — study top 5 best AND top 5 worst posts
            5. Read claude_automation/docs/company/biobuilds-company-overview.md
            6. Read claude_automation/docs/company/BIOBUILDS_BRAND_VOICE_MANIFESTO.md
            7. If hooks/instagram/ has reviewed JSON files, read the most recent
               ones to learn which levers and angles scored highest vs lowest
            8. Read claude_automation/hooks/instagram/examples.json if it exists
               — these are HUMAN-WRITTEN example hooks (gold standard)
               — study their hook_text, angle, lever, and notes carefully
               — match their quality, specificity, and tone
               — do NOT copy them verbatim, but use them as inspiration

            9. Read claude_automation/hooks/instagram/lever-performance.json if it exists
               — shows which psychological levers ACTUALLY perform post-publish
               — weight your 5 hooks toward high-performing levers
               — always include 1 hook using an untested or underperforming lever
               — if a lever has avg_review_score < 30, avoid unless genuinely different

            ===============================================================
            PHASE 2 — CHECK EXISTING (avoid duplication)
            ===============================================================

            8. List claude_automation/output/instagram/ — read last 5 posts
            9. List claude_automation/hooks/instagram/ — read recent hooks
            10. Identify which angles, levers, and topics are overused

            ===============================================================
            PHASE 3 — RESEARCH (fresh data for hooks)
            ===============================================================

            11. Use WebSearch to find 3-5 current data points relevant to
                this week's pillar across DACH + Romania + EU
            12. Find surprising numbers, contrasts, or facts that could
                anchor different hooks

            ===============================================================
            PHASE 4 — GENERATE 10 HOOKS
            ===============================================================

            For each hook, provide ALL of these fields:
            - id: "h01" through "h05"
            - hook_text: The actual opening line (complete, usable sentence)
            - angle: 1-2 sentence description of the full caption approach
            - psychological_lever: One of these categories:
              cost savings, modernity contradiction, time value,
              health/indoor environment, social comparison, material purity,
              lifetime cost, sleep/performance, parental fear, industry failure,
              humor/absurdity, regulation/compliance, investment/roi,
              silence/privacy, summer heat, confrontation/material fight,
              origin story, trust/legitimacy
            - target_audience: Specific segment this hook targets
            - differentiation: Why different from ALL other 9 hooks
            - platform_meta: { "format": "static|carousel|reel", "creative_suggestion": "...", "caption_length": "short|long" }

            RULES FOR HOOKS:
            - Each hook MUST use a DIFFERENT psychological lever
            - At least 1 hook must lead with a specific number or EUR amount
            - At least 1 hook must include DACH-specific data
            - At least 1 hook must include Romania/Eastern Europe angle
            - Humor is welcome but not required for every batch
            - If claude_automation/hooks/instagram/lever-performance.json exists,
              bias toward high-performing levers but always include 1 experimental
              lever not yet tested
            - No two hooks should feel like variations of the same idea
            - Each hook must be genuinely different in TONE, not just topic
            - Write each hook_text as if it were the actual first line of the caption
            - Hooks must pass the "send test" — would someone DM this to their partner?
            - Apply all learned rules from feedback (denied patterns = banned)
            - Hook text must be under 125 characters (Instagram fold limit)

            ===============================================================
            PHASE 5 — SAVE AS JSON
            ===============================================================

            Save to claude_automation/hooks/instagram/${{ steps.date.outputs.today }}.json
            as a valid JSON object:

            {
              "platform": "instagram",
              "date": "${{ steps.date.outputs.today }}",
              "pillar": "${{ steps.pillar.outputs.pillar }}",
              "generated_at": "<ISO timestamp>",
              "status": "pending",
              "hooks": [ ... 5 hook objects ... ]
            }

            ===============================================================
            RULES (violations = failure)
            ===============================================================
            - NEVER use Bash, curl, or shell commands
            - NEVER run git commands
            - NEVER repeat an angle already in recent hooks or posts
            - NEVER use AI-detectable writing patterns in hook_text
            - ALWAYS generate exactly 5 hooks
            - ALWAYS use different psychological levers
            - ALWAYS write hook_text in English

          claude_args: |
            --max-turns 25
            --model claude-opus-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      # --- Commit directly to main -----------------------------------------
      - name: Check for changes
        if: steps.check_hooks.outputs.skip != 'true'
        id: changes
        run: |
          PATHS="hooks/instagram/"
          [ -d "feedback/instagram" ] && PATHS="$PATHS feedback/instagram/"
          STATUS="$(git status --porcelain $PATHS)"
          if [ -z "$STATUS" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "::warning::No new Instagram hooks generated"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected:"
            echo "$STATUS"
          fi

      - name: Commit and push to main
        if: steps.check_hooks.outputs.skip != 'true' && steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add hooks/instagram/
          git add feedback/instagram/ 2>/dev/null || true

          TODAY="${{ steps.date.outputs.today }}"
          PILLAR="${{ steps.pillar.outputs.pillar }}"

          git commit -m "hooks: instagram ${TODAY} [${PILLAR}]"

          # Pull-rebase in case another workflow pushed first, with retry
          for attempt in 1 2 3; do
            git pull --rebase origin ${{ github.event.repository.default_branch }} && \
            git push origin HEAD:${{ github.event.repository.default_branch }} && break
            echo "Push attempt $attempt failed, retrying in $((attempt * 2))s..."
            sleep $((attempt * 2))
          done
