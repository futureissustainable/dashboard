# =============================================================================
# BIOBUILDS Daily Instagram Caption Generator — v2.0
# =============================================================================
#
# Architecture:
#   Runs every weekday (Mon-Fri) at 02:00 UTC.
#   Generates 1 Instagram caption in English that must resonate across all 3
#   markets (DACH, Romania, international) simultaneously.
#   Caption is matched to a creative from Creatives/ if available.
#   Output is committed directly to main in the output/instagram/ folder.
#
# SETUP:
#   1. Run `claude setup-token` locally -> copy the token
#   2. Repo -> Settings -> Secrets -> Actions -> New repository secret:
#      Name:  CLAUDE_CODE_OAUTH_TOKEN
#      Value: (paste token from step 1)
#   3. Place this file at: .github/workflows/daily-instagram-posts.yml
#   4. Merge to default branch (schedule only fires from default branch)
#   5. Test: Actions tab -> "Daily Instagram Posts" -> Run workflow
#
# SECURITY:
#   - Actions pinned to full 40-char commit SHAs
#   - Permissions: contents:write + id-token:write (no PR needed)
#   - OAuth token = high-value credential -> rotate every 60-90 days
#   - Trigger: schedule + workflow_dispatch only (no PR/fork triggers)
# =============================================================================

name: Daily Instagram Posts

on:
  schedule:
    # Every weekday (Mon-Fri) at 02:00 UTC (staggered to avoid push conflicts)
    - cron: '0 2 * * 1-5'
  workflow_dispatch:                # manual trigger from Actions tab

permissions:
  contents: write
  id-token: write

# Prevent overlapping runs
concurrency:
  group: daily-instagram-posts
  cancel-in-progress: false

jobs:
  generate-and-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    defaults:
      run:
        working-directory: claude_automation

    steps:
      # --- Setup -----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 1
          ref: ${{ github.event.repository.default_branch }}

      - name: Set today's date
        id: date
        run: echo "today=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Determine this week's content pillar
        id: pillar
        run: |
          # Rotate through 8 pillars based on ISO week number
          WEEK=$(date -u +%V)
          PILLARS=("Energy & Performance" "Cost & Finance" "Construction & Process" "Materials & Sustainability" "Regulations & Certification" "Living Experience" "Market Comparison" "Lifestyle & Design")
          INDEX=$(( (10#$WEEK - 1) % 8 ))
          echo "pillar=${PILLARS[$INDEX]}" >> "$GITHUB_OUTPUT"
          echo "This week's pillar: ${PILLARS[$INDEX]}"

      - name: Check for new feedback
        id: check_feedback
        run: |
          DIR="feedback/instagram"
          if [ -d "$DIR" ]; then
            NEW=0
            for f in "$DIR"/*.json; do
              [ -f "$f" ] || continue
              if ! jq -e '.summarized == true' "$f" >/dev/null 2>&1; then
                NEW=$((NEW + 1))
              fi
            done
            echo "new_count=$NEW" >> "$GITHUB_OUTPUT"
            [ "$NEW" -gt 0 ] && echo "has_new=true" >> "$GITHUB_OUTPUT" || echo "has_new=false" >> "$GITHUB_OUTPUT"
          else
            echo "new_count=0" >> "$GITHUB_OUTPUT"
            echo "has_new=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Summarize feedback
        if: steps.check_feedback.outputs.has_new == 'true'
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are a feedback summarizer. Update the rolling feedback summary
            for the instagram platform.

            DO NOT run any git commands.

            Steps:
            1. Read claude_automation/feedback/instagram/SUMMARY.md if it exists
            2. List all .json files in claude_automation/feedback/instagram/
            3. Read each JSON file. SKIP any where "summarized" is true.
               If no unsummarized files exist, stop — do nothing.
            4. Update claude_automation/feedback/instagram/SUMMARY.md with this exact format:

            ## Instagram Feedback ({N} posts reviewed)

            ### Patterns to REPEAT
            - [pattern from high-scoring/approved posts] (seen Nx, avg score: X)

            ### Patterns to AVOID
            - [pattern from denied/low-scoring posts] (seen Nx)

            ### Engagement Winners (real post-publish data)
            - YYYY-MM-DD: [key metrics] — [what pattern/angle was used] — [notes]
            (only include posts that have "engagement" data in their JSON)

            ### Recent notes
            - YYYY-MM-DD: status (score/100) — feedback text
            (keep last 10 entries max)

            Rules for updating:
            - Merge new feedback into existing patterns (increment counts)
            - Add new patterns if they don't exist yet
            - If a JSON has "engagement" data, extract the winning pattern
              and add it to "Engagement Winners." This is the highest-value
              signal — real post-publish performance data.
            - Keep "Recent notes" to last 10 entries, drop oldest
            - Be concise: each pattern should be one line
            - Preserve existing pattern counts and averages

            5. For each JSON you processed, update it: add "summarized": true
               to the JSON object and write it back.

          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep"

      - name: Collect feedback summary
        id: feedback
        run: |
          SUMMARY_FILE="feedback/instagram/SUMMARY.md"
          if [ -f "$SUMMARY_FILE" ]; then
            CONTENT=$(head -c 2000 "$SUMMARY_FILE")
            DELIM="FEEDBACK_SUMMARY_$(date +%s)"
            echo "summary<<${DELIM}" >> "$GITHUB_OUTPUT"
            echo "$CONTENT" >> "$GITHUB_OUTPUT"
            echo "${DELIM}" >> "$GITHUB_OUTPUT"
            echo "has_feedback=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_feedback=false" >> "$GITHUB_OUTPUT"
            echo "summary=No feedback yet" >> "$GITHUB_OUTPUT"
          fi

      - name: List available creatives
        id: creatives
        run: |
          # Check for actual media files (not just CATALOG.md and .gitkeep)
          MEDIA_FILES=$(find Creatives/ -type f \
            \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \
               -o -iname '*.webp' -o -iname '*.mp4' -o -iname '*.mov' \
               -o -iname '*.gif' \) 2>/dev/null | head -50)

          if [ -n "$MEDIA_FILES" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
            DELIM="CREATIVES_LIST_$(date +%s)"
            echo "list<<${DELIM}" >> "$GITHUB_OUTPUT"
            echo "$MEDIA_FILES" >> "$GITHUB_OUTPUT"
            echo "${DELIM}" >> "$GITHUB_OUTPUT"

            # Include catalog if it exists
            if [ -f "Creatives/CATALOG.md" ]; then
              echo "has_catalog=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_catalog=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "list=No creatives available" >> "$GITHUB_OUTPUT"
            echo "has_catalog=false" >> "$GITHUB_OUTPUT"
          fi

      # --- Rate creatives (pick highest potential) --------------------------
      - name: Rate creatives for Instagram
        if: steps.creatives.outputs.available == 'true' && steps.creatives.outputs.has_catalog == 'true'
        id: rate_creatives
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are a creative asset analyst for BioBuilds' Instagram content.
            Today's date: ${{ steps.date.outputs.today }}
            This week's content pillar: ${{ steps.pillar.outputs.pillar }}

            Your job: rate every available creative 0-100 for how well it would
            perform on Instagram this week, given the current pillar.

            DO NOT run any git commands.

            Steps:
            1. Read claude_automation/Creatives/CATALOG.md for descriptions and
               status of each creative asset
            2. Read claude_automation/docs/instagram/INSTAGRAM_PLAYBOOK.md for what
               visuals and formats perform best on Instagram
            3. Read claude_automation/docs/instagram/INSTAGRAM_SOUL.md for the
               proven visual formula and visual rules
            4. Read claude_automation/docs/instagram/instagram-past-posts.md and study
               which visuals drove the highest engagement. What creative styles
               correlated with top performers? What visual killed engagement?
            5. List files in claude_automation/output/instagram/ and read the last 5
               posts to see which creatives were already used recently

            Now rate EVERY creative in the catalog that is AVAILABLE for Instagram.
            Available statuses: [available], [USED ON LINKEDIN], [REQUEST USE LINKEDIN]
            Skip: [reserved], [USED ON INSTA], [USED ON BOTH], [REQUEST USE INSTA]

            For each available creative, score 0-100 considering:
            - How well does it match this week's pillar (${{ steps.pillar.outputs.pillar }})?
            - Does it follow the proven visual formula? (Winter + warm glow + nature + human)
            - Would it stop the scroll on Instagram specifically?
            - Is it fresh (not recently used on Instagram)?
            - Would someone DM this image to their partner? (the "send test")
            - Does it create emotional contrast?

            Write your ratings to claude_automation/.creative-ratings-instagram.md
            in this exact format:

            # Creative Ratings — Instagram — ${{ steps.date.outputs.today }}
            Pillar: ${{ steps.pillar.outputs.pillar }}

            | Score | Creative | Reason |
            |-------|----------|--------|
            | 95 | filename1.jpg | One-line reason |
            | 82 | filename2.jpg | One-line reason |

            Sort by score DESCENDING. Top creative = best match for today's post.

          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep"

      - name: Collect creative ratings
        id: creative_ratings
        run: |
          RATINGS_FILE=".creative-ratings-instagram.md"
          if [ -f "$RATINGS_FILE" ]; then
            CONTENT=$(head -c 3000 "$RATINGS_FILE")
            DELIM="CREATIVE_RATINGS_$(date +%s)"
            echo "ratings<<${DELIM}" >> "$GITHUB_OUTPUT"
            echo "$CONTENT" >> "$GITHUB_OUTPUT"
            echo "${DELIM}" >> "$GITHUB_OUTPUT"
            echo "has_ratings=true" >> "$GITHUB_OUTPUT"
            rm -f "$RATINGS_FILE"
          else
            echo "has_ratings=false" >> "$GITHUB_OUTPUT"
            echo "ratings=No creative ratings available" >> "$GITHUB_OUTPUT"
          fi

      # --- Pattern innovation (analyze what works, propose experiment) ------
      - name: Analyze winning patterns and propose experiment
        id: innovation
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are a content strategist analyzing past post performance to
            find winning patterns and propose experiments for Instagram.
            Today's date: ${{ steps.date.outputs.today }}
            This week's pillar: ${{ steps.pillar.outputs.pillar }}

            DO NOT run any git commands.

            Steps:
            1. Read claude_automation/docs/instagram/instagram-past-posts.md
               — this has 62 real posts with likes, comments, shares, saves,
               reach, follows, image descriptions, and full captions
            2. Read claude_automation/feedback/instagram/SUMMARY.md if it exists
            3. Read claude_automation/docs/instagram/INSTAGRAM_SOUL.md
               — focus on "Learned Rules from Feedback" section
            4. List files in claude_automation/output/instagram/ and read the
               last 5 generated captions
            5. Read all .json files in claude_automation/feedback/instagram/
               — look for any with "engagement" data (real post-publish metrics)
            6. Read claude_automation/docs/company/MEANING-OVER-PRODUCT.md
               — use this movement/story psychology lens when analyzing which
               patterns work and proposing today's experiment

            ANALYSIS:
            - Rank top 5 past posts by saves (strongest purchase-intent signal),
              then by shares (DM sends = Instagram's #1 algorithm signal)
            - For each: identify the SPECIFIC pattern that made it work
              (not vague — be precise about visual + caption combo)
            - Cross-reference with denied patterns
            - Note: static images get 4x more follows than reels based on
              past data. Factor this into experiment design.
            - If engagement data exists in feedback JSONs, weight those
              insights highest — that's real post-publish performance

            Write output to claude_automation/.pattern-innovation-instagram.md:

            ## Winning Patterns (from real data)
            1. [Pattern] — Evidence: [Post title, metrics] — Why: [reason]
            2. [Pattern] — Evidence: [Post title, metrics] — Why: [reason]
            3. [Pattern] — Evidence: [Post title, metrics] — Why: [reason]

            ## Today's Experiment
            [One specific technique/angle/format to test that hasn't been
            tried in the last 5 generated captions. Be creative. The best
            Instagram posts make someone screenshot and DM it to their partner.]
            Hypothesis: [Why this should work, based on patterns above]
            How to measure: [saves and shares are the key signals]

            ## Avoid Today
            - [Specific anti-pattern from denied posts or low performers]

          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep"

      - name: Collect innovation brief
        id: innovation_brief
        run: |
          BRIEF_FILE=".pattern-innovation-instagram.md"
          if [ -f "$BRIEF_FILE" ]; then
            CONTENT=$(head -c 3000 "$BRIEF_FILE")
            DELIM="INNOVATION_BRIEF_$(date +%s)"
            echo "brief<<${DELIM}" >> "$GITHUB_OUTPUT"
            echo "$CONTENT" >> "$GITHUB_OUTPUT"
            echo "${DELIM}" >> "$GITHUB_OUTPUT"
            rm -f "$BRIEF_FILE"
          else
            echo "brief=No innovation brief available" >> "$GITHUB_OUTPUT"
          fi

      # --- Generate single caption (all markets) ---------------------------
      - name: Generate Instagram caption (all markets)
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are an Instagram caption generator for the BioBuilds content strategy.
            Today's date: ${{ steps.date.outputs.today }}
            This week's content pillar: ${{ steps.pillar.outputs.pillar }}
            Creatives available: ${{ steps.creatives.outputs.available }}
            Creative files: ${{ steps.creatives.outputs.list }}
            Creative catalog available: ${{ steps.creatives.outputs.has_catalog }}

            ===============================================================
            CREATIVE RATINGS (pre-analyzed by Sonnet — pick from the top)
            ===============================================================
            ${{ steps.creative_ratings.outputs.ratings }}

            When selecting a creative, ALWAYS pick the highest-rated one from
            the ratings above unless you have a strong, specific reason not to.
            The ratings already account for pillar match, visual formula,
            freshness, and the "send test." Trust them.

            ===============================================================
            INNOVATION BRIEF (winning patterns + today's experiment)
            ===============================================================
            ${{ steps.innovation_brief.outputs.brief }}

            This brief was generated by analyzing your 62 top-performing
            past posts. The "Today's Experiment" is a specific technique
            to test. Use it. Break a rule if the experiment calls for it.
            The best posts in history broke rules intentionally.

            ===============================================================
            RECENT FEEDBACK ON PAST INSTAGRAM POSTS (learn from this)
            ===============================================================
            ${{ steps.feedback.outputs.summary }}

            Apply these lessons: repeat what scored high, fix what was denied
            or scored low. This is non-negotiable.

            DO NOT run any git commands.
            DO NOT create branches, commits, or pull requests.

            ===============================================================
            THE CORE CHALLENGE
            ===============================================================

            You must write ONE Instagram caption in ENGLISH that simultaneously
            resonates with BioBuilds' two primary markets and broader
            European audience:
            - DACH (Germany, Austria, Switzerland) — primary market
            - Romania — young families (30-45), ~70% IT industry, rest
              entrepreneurs or higher-paying professions. NOT luxury.
            - International (rest of EU) — secondary reach

            The caption must pass the "send test": would someone DM this
            to their partner when they're both thinking about building?

            HOW TO DO THIS:
            - Lead with a universal contrast that hits everywhere ("EUR 2,000
              vs EUR 100 heating," "-10 outside, 24 inside," "3 weeks vs 3 years")
            - Use visuals that transcend language (warmth, nature, family, contrast)
            - Include one specific number that works across all markets
            - Avoid market-specific jargon (no KfW numbers, no Romanian-only references)
            - The emotion must be universal: "this is the life I want"

            ===============================================================
            AVAILABLE TOOLS (use ONLY these)
            ===============================================================
            You have ONLY these tools: Read, Write, Edit, Glob, Grep,
            WebSearch, WebFetch.

            Bash, curl, shell commands are NOT available.

            ===============================================================
            PHASE 1 — READ ALL INSTRUCTIONS (mandatory, do not skip)
            ===============================================================

            1. Read claude_automation/CLAUDE.md — project rules and constraints
            2. Read claude_automation/docs/instagram/INSTAGRAM_SOUL.md — voice, writing rules,
               visual matching, audience segments, output format.
               CRITICAL: This file begins with "Learned Rules from Feedback" — hand-curated
               denied patterns with specific scores. These are NON-NEGOTIABLE. Read them first,
               internalize them, and never repeat a denied pattern.
            3. Read claude_automation/docs/instagram/INSTAGRAM_PLAYBOOK.md — platform strategy,
               algorithm signals, visual guidelines, posting mechanics

            4. *** MANDATORY — STUDY TOP 3 BEST AND TOP 3 WORST POSTS ***
               Read claude_automation/docs/instagram/instagram-past-posts.md — full past
               post data. You MUST study at minimum the top 3 best-performing posts AND
               the top 3 worst-performing posts. For each, understand WHY it succeeded
               or failed. What made the hook work? What visual resonated? What killed it?
               You may read additional posts for broader patterns and reference.

               HARD RULE: You may draw INSPIRATION from past phrasing, hooks, and
               structures that worked — but you must always iterate, improve, and
               innovate on them. Never copy word-for-word. Every post must push
               forward: test new angles, sharpen what worked, evolve the voice.
               The goal is continuous improvement, not repetition.

            5. Read claude_automation/docs/company/biobuilds-company-overview.md — company data
            6. Read claude_automation/docs/company/MEANING-OVER-PRODUCT.md — psychology of
               movement/story-driven marketing over product-first marketing. Internalize these
               principles and apply them to today's post.
            7. Read claude_automation/.agents/skills/seo-audit/references/ai-writing-detection.md
            8. If creatives are available, read claude_automation/Creatives/CATALOG.md first for
               descriptions and metadata about each file, then list folder contents

            ===============================================================
            PHASE 2 — CHECK EXISTING POSTS (avoid duplication)
            ===============================================================

            9. List all files in claude_automation/output/instagram/ directory
            10. Read the last 5 Instagram posts (if they exist) and extract:
                - What topics were already covered
                - What visual styles were used
                - What segments were targeted
                - What caption styles performed (short vs long)
            11. Make sure your post covers NEW ground

            ===============================================================
            PHASE 3 — MATCH CREATIVE (if available)
            ===============================================================

            12. If claude_automation/Creatives/ has files, read claude_automation/Creatives/CATALOG.md and use the
                descriptions and status to pick the best match for this week's
                pillar and today's topic.
                ONLY pick creatives that Instagram hasn't already used.
                OK to pick: [available], [USED ON LINKEDIN], [REQUEST USE LINKEDIN]
                Skip: [reserved], [USED ON INSTA], [USED ON BOTH], [REQUEST USE INSTA]
                A creative used on LinkedIn can still be used on Instagram.
            13. If you pick a creative from the catalog, set the frontmatter
                field creative_status to "REQUEST USE INSTA" and explain in
                the post file why you chose it.
            14. If no creatives match or none exist, create a detailed
                creative_brief describing the ideal visual instead.

            ===============================================================
            PHASE 4 — WRITE THE CAPTION (English, all markets)
            ===============================================================

            15. Pick ONE primary audience segment but ensure cross-market appeal
            16. Choose a format: static, carousel, or reel
            17. Choose caption length: short (<50 words) or long (200-400 words)
                NEVER write medium-length product descriptions
            18. Write the full Instagram caption IN ENGLISH following ALL rules
                in INSTAGRAM_SOUL.md:
                - First 125 characters must stop the scroll
                - Lead with contrast, not product
                - Pass the "send test" across all 3 markets
                - Include 2-3 specific data points woven naturally
                - Use keywords in caption instead of hashtags where possible
                - Maximum 3-5 hashtags if using any (test zero)
                - NO AI writing tells
                - NO spec dumps as the lead
            19. Include creative_brief or creative_file match.
                If using a catalog creative, set:
                  creative_file: "claude_automation/Creatives/filename.jpg"
                  creative_status: "REQUEST USE INSTA"
                If no catalog match, provide creative_brief only.
            20. Save to claude_automation/output/instagram/ as:
                ${{ steps.date.outputs.today }}_[slug].md

            ===============================================================
            RULES (violations = failure)
            ===============================================================
            - NEVER frame BioBuilds as building offices or commercial spaces (we build HOMES)
            - NEVER use Bash, curl, or shell commands
            - NEVER run git commands
            - NEVER lead with specs (lead with feeling, prove with specs)
            - NEVER write medium-length product descriptions
            - NEVER use words like "revolutionary," "game-changer," "seamless"
            - NEVER describe wrapped modules on trucks in the creative brief
            - ALWAYS write in English
            - ALWAYS pass the "send test" for all 3 markets
            - ALWAYS include YAML frontmatter per INSTAGRAM_SOUL.md
            - ALWAYS lead with contrast
            - ALWAYS include a creative_brief or creative_file reference
            - NEVER copy a past post word-for-word — inspire from what worked, then iterate and improve
            - Every post must push forward — test new angles, sharpen winners, evolve the voice

          claude_args: |
            --max-turns 35
            --model claude-opus-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      # --- Commit directly to main -----------------------------------------
      - name: Check for changes
        id: changes
        run: |
          PATHS="output/instagram/"
          [ -d "feedback/instagram" ] && PATHS="$PATHS feedback/instagram/"
          STATUS="$(git status --porcelain $PATHS)"
          if [ -z "$STATUS" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "::warning::No new Instagram post generated"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected:"
            echo "$STATUS"
          fi

      - name: Commit and push to main
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add output/instagram/
          git add feedback/instagram/ 2>/dev/null || true

          TODAY="${{ steps.date.outputs.today }}"
          PILLAR="${{ steps.pillar.outputs.pillar }}"

          git commit -m "instagram: ${TODAY} [${PILLAR}]"

          # Pull-rebase in case another workflow pushed first, with retry
          for attempt in 1 2 3; do
            git pull --rebase origin ${{ github.event.repository.default_branch }} && \
            git push origin HEAD:${{ github.event.repository.default_branch }} && break
            echo "Push attempt $attempt failed, retrying in $((attempt * 2))s..."
            sleep $((attempt * 2))
          done
