# =============================================================================
# Creative Assets Catalog Check
# =============================================================================
#
# Runs when files are pushed to the Creatives/ folder.
# Checks if new files have a matching entry in CATALOG.md.
# Opens an issue if any files are undocumented.
#
# =============================================================================

name: Check Creative Catalog

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'claude_automation/Creatives/**'
      - '!claude_automation/Creatives/CATALOG.md'
      - '!claude_automation/Creatives/.gitkeep'

permissions:
  contents: read
  issues: write

jobs:
  check-catalog:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    defaults:
      run:
        working-directory: claude_automation

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Check for undocumented creatives
        id: check
        run: |
          # Guard: if CATALOG.md doesn't exist, all files are undocumented
          if [ ! -f "Creatives/CATALOG.md" ]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "::warning::Creatives/CATALOG.md does not exist"
            exit 0
          fi

          UNDOCUMENTED=""

          # Search recursively for media files (matches content workflow behavior)
          while IFS= read -r file; do
            basename=$(basename "$file")

            # Check if filename appears in CATALOG.md
            if ! grep -qwF "$basename" Creatives/CATALOG.md; then
              UNDOCUMENTED="${UNDOCUMENTED}- \`${basename}\`\n"
            fi
          done < <(find Creatives/ -type f \
            \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \
               -o -iname '*.webp' -o -iname '*.mp4' -o -iname '*.mov' \
               -o -iname '*.gif' \))

          if [ -n "$UNDOCUMENTED" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            DELIM="UNDOCUMENTED_FILES_$(date +%s)"
            echo "files<<${DELIM}" >> "$GITHUB_OUTPUT"
            printf '%b' "$UNDOCUMENTED" >> "$GITHUB_OUTPUT"
            echo "${DELIM}" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issue for undocumented creatives
        if: steps.check.outputs.found == 'true'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        env:
          UNDOCUMENTED_FILES: ${{ steps.check.outputs.files }}
        with:
          script: |
            const files = process.env.UNDOCUMENTED_FILES;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'New creatives need catalog entries',
              body: `The following files were added to \`Creatives/\` but don't have entries in \`Creatives/CATALOG.md\`:\n\n${files}\n\n**To fix:** Edit \`Creatives/CATALOG.md\` and add an entry for each file using the template in that file.\n\nThe Instagram and LinkedIn automations use the catalog to match captions to visuals. Without an entry, they can only guess from the filename.`
            });
