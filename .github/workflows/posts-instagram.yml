# =============================================================================
# BIOBUILDS Instagram Post Writer (Phase 2) — v1.0
# =============================================================================
#
# Architecture:
#   Triggered from the dashboard after human approves hooks.
#   Writes a full Instagram caption for each approved hook.
#   Output is committed directly to main in the output/instagram/ folder.
# =============================================================================

name: Write Instagram Posts (Phase 2)

on:
  workflow_dispatch:
    inputs:
      date:
        description: 'Date of hooks to develop (YYYY-MM-DD)'
        required: true
      hook_ids:
        description: 'Comma-separated hook IDs to develop (e.g., h01,h05,h09)'
        required: false
        default: ''
      reroll:
        description: 'Is this a re-roll of a specific hook?'
        required: false
        default: 'false'
      reroll_feedback:
        description: 'Feedback for re-roll (what to change)'
        required: false
        default: ''

permissions:
  contents: write
  id-token: write

concurrency:
  group: posts-instagram
  cancel-in-progress: false

jobs:
  write-posts:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    defaults:
      run:
        working-directory: claude_automation

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 1
          ref: ${{ github.event.repository.default_branch }}

      - name: Set date
        id: date
        run: echo "today=${{ github.event.inputs.date }}" >> "$GITHUB_OUTPUT"

      - name: Read hooks file
        id: hooks
        run: |
          HOOKS_FILE="hooks/instagram/${{ steps.date.outputs.today }}.json"
          if [ ! -f "$HOOKS_FILE" ]; then
            echo "::error::No hooks file found at $HOOKS_FILE"
            exit 1
          fi

          INPUT_IDS="${{ github.event.inputs.hook_ids }}"
          if [ -n "$INPUT_IDS" ]; then
            HOOK_IDS="$INPUT_IDS"
          else
            HOOK_IDS=$(python3 -c "
          import json
          data = json.load(open('$HOOKS_FILE'))
          if data.get('review'):
              print(','.join(data['review']['approved_hook_ids']))
          " 2>/dev/null || echo "")
          fi

          echo "hook_ids=$HOOK_IDS" >> "$GITHUB_OUTPUT"
          echo "hooks_file=$HOOKS_FILE" >> "$GITHUB_OUTPUT"
          echo "Hook IDs to develop: $HOOK_IDS"

          PILLAR=$(python3 -c "import json; print(json.load(open('$HOOKS_FILE'))['pillar'])" 2>/dev/null || echo "")
          echo "pillar=$PILLAR" >> "$GITHUB_OUTPUT"

      - name: Write Instagram captions for approved hooks
        if: steps.hooks.outputs.hook_ids != ''
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are an Instagram caption writer for BioBuilds.
            Today's date: ${{ steps.date.outputs.today }}
            Content pillar: ${{ steps.hooks.outputs.pillar }}
            Hooks file: claude_automation/${{ steps.hooks.outputs.hooks_file }}
            Hook IDs to develop: ${{ steps.hooks.outputs.hook_ids }}
            Is re-roll: ${{ github.event.inputs.reroll }}
            Re-roll feedback: ${{ github.event.inputs.reroll_feedback }}

            DO NOT run any git commands.

            ===============================================================
            PHASE 1 — READ HOOKS + STRATEGY DOCS
            ===============================================================

            1. Read claude_automation/${{ steps.hooks.outputs.hooks_file }}
               — find hooks matching IDs: ${{ steps.hooks.outputs.hook_ids }}
            2. Read claude_automation/CLAUDE.md
            3. Read claude_automation/docs/instagram/INSTAGRAM_SOUL.md
               — CRITICAL: "Learned Rules from Feedback" are NON-NEGOTIABLE
            4. Read claude_automation/docs/instagram/INSTAGRAM_PLAYBOOK.md
            5. Read claude_automation/docs/instagram/instagram-past-posts.md
               — study top 3 best AND top 3 worst posts
            6. Read claude_automation/docs/company/biobuilds-company-overview.md
            7. Read claude_automation/docs/company/BIOBUILDS_BRAND_VOICE_MANIFESTO.md
            8. Read claude_automation/.agents/skills/seo-audit/references/ai-writing-detection.md
            9. Read claude_automation/Creatives/CATALOG.md

            ===============================================================
            PHASE 2 — CHECK EXISTING + MATCH CREATIVE
            ===============================================================

            10. List claude_automation/output/instagram/ — read last 5 posts
            11. Pick best creative from catalog for each hook's angle
                OK: [available], [USED ON LINKEDIN], [REQUEST USE LINKEDIN]
                Skip: [reserved], [USED ON INSTA], [USED ON BOTH], [REQUEST USE INSTA]

            ===============================================================
            PHASE 3 — WRITE CAPTION(S)
            ===============================================================

            For EACH approved hook ID, write a full Instagram caption:

            - Use the hook_text as your opening (may refine slightly)
            - Follow ALL rules in INSTAGRAM_SOUL.md
            - First 125 characters must stop the scroll
            - Lead with contrast, not product
            - Pass the "send test"
            - Short (<50 words) or long (200-400 words) — NO medium
            - Include 2-3 specific data points
            - Maximum 3-5 hashtags
            - NO AI writing tells, NO spec dumps as lead
            - Include creative_file or creative_brief

            YAML frontmatter MUST include:
              hook_id: "<the hook ID>"
            Plus all standard Instagram frontmatter fields.

            If RE-ROLL (${{ github.event.inputs.reroll }} == 'true'):
            - Regenerate only the specific hook's caption
            - Read previous version for context
            - Apply feedback: ${{ github.event.inputs.reroll_feedback }}
            - Save with -v2/-v3 suffix, include reroll_version in frontmatter

            Save to claude_automation/output/instagram/ as:
            ${{ steps.date.outputs.today }}_[slug].md

            ===============================================================
            RULES
            ===============================================================
            - NEVER frame BioBuilds as building offices (we build HOMES)
            - NEVER use Bash, curl, or shell commands
            - NEVER run git commands
            - NEVER write medium-length product descriptions
            - ALWAYS include hook_id in YAML frontmatter
            - ALWAYS pass the "send test"
            - ALWAYS lead with contrast

          claude_args: |
            --max-turns 35
            --model claude-opus-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      - name: Check for changes
        if: steps.hooks.outputs.hook_ids != ''
        id: changes
        run: |
          STATUS="$(git status --porcelain output/instagram/)"
          if [ -z "$STATUS" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push to main
        if: steps.hooks.outputs.hook_ids != '' && steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add output/instagram/

          TODAY="${{ steps.date.outputs.today }}"
          PILLAR="${{ steps.hooks.outputs.pillar }}"
          REROLL="${{ github.event.inputs.reroll }}"

          if [ "$REROLL" = "true" ]; then
            git commit -m "instagram: reroll ${TODAY} [${PILLAR}]"
          else
            git commit -m "instagram: posts ${TODAY} [${PILLAR}]"
          fi

          for attempt in 1 2 3; do
            git pull --rebase origin ${{ github.event.repository.default_branch }} && \
            git push origin HEAD:${{ github.event.repository.default_branch }} && break
            echo "Push attempt $attempt failed, retrying in $((attempt * 2))s..."
            sleep $((attempt * 2))
          done
