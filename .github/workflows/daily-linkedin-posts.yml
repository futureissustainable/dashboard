# =============================================================================
# BIOBUILDS Daily LinkedIn Post Generator — v2.0
# =============================================================================
#
# Architecture:
#   Runs every weekday (Mon-Fri) at 01:30 UTC.
#   Generates 1 LinkedIn post in English that must resonate across all 3
#   markets (DACH, Romania, international) simultaneously.
#   Output is committed directly to main in the output/linkedin/ folder.
#
# SETUP:
#   1. Run `claude setup-token` locally -> copy the token
#   2. Repo -> Settings -> Secrets -> Actions -> New repository secret:
#      Name:  CLAUDE_CODE_OAUTH_TOKEN
#      Value: (paste token from step 1)
#   3. Place this file at: .github/workflows/daily-linkedin-posts.yml
#   4. Merge to default branch (schedule only fires from default branch)
#   5. Test: Actions tab -> "Daily LinkedIn Posts" -> Run workflow
#
# SECURITY:
#   - Actions pinned to full 40-char commit SHAs
#   - Permissions: contents:write + id-token:write (no PR needed)
#   - OAuth token = high-value credential -> rotate every 60-90 days
#   - Trigger: schedule + workflow_dispatch only (no PR/fork triggers)
# =============================================================================

name: Daily LinkedIn Posts

on:
  schedule:
    # Every weekday (Mon-Fri) at 01:30 UTC (staggered to avoid push conflicts)
    - cron: '30 1 * * 1-5'
  workflow_dispatch:                # manual trigger from Actions tab

permissions:
  contents: write
  id-token: write

# Prevent overlapping runs
concurrency:
  group: daily-linkedin-posts
  cancel-in-progress: false

jobs:
  generate-and-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    defaults:
      run:
        working-directory: claude_automation

    steps:
      # --- Setup -----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 1
          ref: ${{ github.event.repository.default_branch }}

      - name: Set today's date
        id: date
        run: echo "today=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Determine this week's content pillar
        id: pillar
        run: |
          # Rotate through 8 pillars based on ISO week number
          WEEK=$(date -u +%V)
          PILLARS=("Energy & Performance" "Cost & Finance" "Construction & Process" "Materials & Sustainability" "Regulations & Certification" "Living Experience" "Market Comparison" "Lifestyle & Design")
          INDEX=$(( (10#$WEEK - 1) % 8 ))
          echo "pillar=${PILLARS[$INDEX]}" >> "$GITHUB_OUTPUT"
          echo "This week's pillar: ${PILLARS[$INDEX]}"

      - name: Check for new feedback
        id: check_feedback
        run: |
          DIR="feedback/linkedin"
          if [ -d "$DIR" ]; then
            NEW=0
            for f in "$DIR"/*.json; do
              [ -f "$f" ] || continue
              if ! jq -e '.summarized == true' "$f" >/dev/null 2>&1; then
                NEW=$((NEW + 1))
              fi
            done
            echo "new_count=$NEW" >> "$GITHUB_OUTPUT"
            [ "$NEW" -gt 0 ] && echo "has_new=true" >> "$GITHUB_OUTPUT" || echo "has_new=false" >> "$GITHUB_OUTPUT"
          else
            echo "new_count=0" >> "$GITHUB_OUTPUT"
            echo "has_new=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Summarize feedback
        if: steps.check_feedback.outputs.has_new == 'true'
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are a feedback summarizer. Update the rolling feedback summary
            for the linkedin platform.

            DO NOT run any git commands.

            Steps:
            1. Read claude_automation/feedback/linkedin/SUMMARY.md if it exists
            2. List all .json files in claude_automation/feedback/linkedin/
            3. Read each JSON file. SKIP any where "summarized" is true.
               If no unsummarized files exist, stop — do nothing.
            4. Update claude_automation/feedback/linkedin/SUMMARY.md with this exact format:

            ## LinkedIn Feedback ({N} posts reviewed)

            ### Patterns to REPEAT
            - [pattern from high-scoring/approved posts] (seen Nx, avg score: X)

            ### Patterns to AVOID
            - [pattern from denied/low-scoring posts] (seen Nx)

            ### Recent notes
            - YYYY-MM-DD: status (score/100) — feedback text
            (keep last 10 entries max)

            Rules for updating:
            - Merge new feedback into existing patterns (increment counts)
            - Add new patterns if they don't exist yet
            - Keep "Recent notes" to last 10 entries, drop oldest
            - Be concise: each pattern should be one line
            - Preserve existing pattern counts and averages

            5. For each JSON you processed, update it: add "summarized": true
               to the JSON object and write it back.

          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep"

      - name: Collect feedback summary
        id: feedback
        run: |
          SUMMARY_FILE="feedback/linkedin/SUMMARY.md"
          if [ -f "$SUMMARY_FILE" ]; then
            CONTENT=$(head -c 2000 "$SUMMARY_FILE")
            DELIM="FEEDBACK_SUMMARY_$(date +%s)"
            echo "summary<<${DELIM}" >> "$GITHUB_OUTPUT"
            echo "$CONTENT" >> "$GITHUB_OUTPUT"
            echo "${DELIM}" >> "$GITHUB_OUTPUT"
            echo "has_feedback=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_feedback=false" >> "$GITHUB_OUTPUT"
            echo "summary=No feedback yet" >> "$GITHUB_OUTPUT"
          fi

      - name: List available creatives
        id: creatives
        run: |
          # Check for actual media files (not just CATALOG.md and .gitkeep)
          MEDIA_FILES=$(find Creatives/ -type f \
            \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \
               -o -iname '*.webp' -o -iname '*.mp4' -o -iname '*.mov' \
               -o -iname '*.gif' \) 2>/dev/null | head -50)

          if [ -n "$MEDIA_FILES" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
            DELIM="CREATIVES_LIST_$(date +%s)"
            echo "list<<${DELIM}" >> "$GITHUB_OUTPUT"
            echo "$MEDIA_FILES" >> "$GITHUB_OUTPUT"
            echo "${DELIM}" >> "$GITHUB_OUTPUT"

            if [ -f "Creatives/CATALOG.md" ]; then
              echo "has_catalog=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_catalog=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "list=No creatives available" >> "$GITHUB_OUTPUT"
            echo "has_catalog=false" >> "$GITHUB_OUTPUT"
          fi

      # --- Rate creatives (pick highest potential) --------------------------
      - name: Rate creatives for LinkedIn
        if: steps.creatives.outputs.available == 'true' && steps.creatives.outputs.has_catalog == 'true'
        id: rate_creatives
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are a creative asset analyst for BioBuilds' LinkedIn content.
            Today's date: ${{ steps.date.outputs.today }}
            This week's content pillar: ${{ steps.pillar.outputs.pillar }}

            Your job: rate every available creative 0-100 for how well it would
            perform on LinkedIn this week, given the current pillar.

            DO NOT run any git commands.

            Steps:
            1. Read claude_automation/Creatives/CATALOG.md for descriptions and
               status of each creative asset
            2. Read claude_automation/docs/linkedin/LINKEDIN_PLAYBOOK.md for what
               visuals and formats perform best on LinkedIn
            3. Read claude_automation/docs/linkedin/LINKEDIN_SOUL.md for visual
               matching rules and format strategy
            4. Read claude_automation/docs/linkedin/linkedin-past-posts.md and study
               which visuals drove the highest engagement. What creative styles
               correlated with top performers?
            5. List files in claude_automation/output/linkedin/ and read the last 5
               posts to see which creatives were already used recently

            Now rate EVERY creative in the catalog that is AVAILABLE for LinkedIn.
            Available statuses: [available], [USED ON INSTA], [REQUEST USE INSTA]
            Skip: [reserved], [USED ON LINKEDIN], [USED ON BOTH], [REQUEST USE LINKEDIN]

            For each available creative, score 0-100 considering:
            - How well does it match this week's pillar (${{ steps.pillar.outputs.pillar }})?
            - Does it follow the proven visual formula from past top performers?
            - Would it stop the scroll on LinkedIn specifically?
            - Is it fresh (not recently used on LinkedIn)?
            - Does it create emotional contrast or tell a story?

            Write your ratings to claude_automation/.creative-ratings-linkedin.md
            in this exact format:

            # Creative Ratings — LinkedIn — ${{ steps.date.outputs.today }}
            Pillar: ${{ steps.pillar.outputs.pillar }}

            | Score | Creative | Reason |
            |-------|----------|--------|
            | 95 | filename1.jpg | One-line reason |
            | 82 | filename2.jpg | One-line reason |

            Sort by score DESCENDING. Top creative = best match for today's post.

          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep"

      - name: Collect creative ratings
        id: creative_ratings
        run: |
          RATINGS_FILE=".creative-ratings-linkedin.md"
          if [ -f "$RATINGS_FILE" ]; then
            CONTENT=$(head -c 3000 "$RATINGS_FILE")
            DELIM="CREATIVE_RATINGS_$(date +%s)"
            echo "ratings<<${DELIM}" >> "$GITHUB_OUTPUT"
            echo "$CONTENT" >> "$GITHUB_OUTPUT"
            echo "${DELIM}" >> "$GITHUB_OUTPUT"
            echo "has_ratings=true" >> "$GITHUB_OUTPUT"
            rm -f "$RATINGS_FILE"
          else
            echo "has_ratings=false" >> "$GITHUB_OUTPUT"
            echo "ratings=No creative ratings available" >> "$GITHUB_OUTPUT"
          fi

      # --- Generate single post (all markets) ------------------------------
      - name: Generate LinkedIn post (all markets)
        uses: anthropics/claude-code-action@68cfeead1890300cc87935dbe2c023825be87b8a
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are a LinkedIn post generator for the BioBuilds content strategy.
            Today's date: ${{ steps.date.outputs.today }}
            This week's content pillar: ${{ steps.pillar.outputs.pillar }}
            Creatives available: ${{ steps.creatives.outputs.available }}
            Creative files: ${{ steps.creatives.outputs.list }}
            Creative catalog available: ${{ steps.creatives.outputs.has_catalog }}

            ===============================================================
            CREATIVE RATINGS (pre-analyzed by Sonnet — pick from the top)
            ===============================================================
            ${{ steps.creative_ratings.outputs.ratings }}

            When selecting a creative, ALWAYS pick the highest-rated one from
            the ratings above unless you have a strong, specific reason not to.
            The ratings already account for pillar match, visual formula, and
            freshness. Trust them.

            ===============================================================
            RECENT FEEDBACK ON PAST LINKEDIN POSTS (learn from this)
            ===============================================================
            ${{ steps.feedback.outputs.summary }}

            Apply these lessons: repeat what scored high, fix what was denied
            or scored low. This is non-negotiable.

            DO NOT run any git commands.
            DO NOT create branches, commits, or pull requests.

            ===============================================================
            THE CORE CHALLENGE
            ===============================================================

            You must write ONE LinkedIn post in ENGLISH that simultaneously
            resonates with BioBuilds' two primary markets and broader
            European audience:
            - DACH (Germany, Austria, Switzerland) — primary market
            - Romania — young families (30-45), ~70% IT industry, rest
              entrepreneurs or higher-paying professions. NOT luxury.
            - International (rest of EU) — secondary reach

            This is the hard part. The post must feel relevant to someone
            researching homes in Germany AND a young Romanian IT couple
            planning their first house AND anyone else in Europe thinking
            about building. One post, multiple audiences, zero compromise
            on specificity. Don't over-define who reads it beyond this.

            HOW TO DO THIS:
            - Use data points that cross borders (EU energy prices, Passivhaus
              standards, EUR pricing, construction timelines)
            - Reference multiple markets naturally ("from the Black Forest to
              the Carpathians," "whether your building code says KfW 40 or
              nZEB")
            - Include at least one DACH-specific data point (KfW, German
              energy prices, Fertighaus market)
            - Include at least one Romania/Eastern Europe angle (manufacturing
              origin, cost advantage, certification despite skepticism)
            - The universal hook must be a number or contrast that works
              everywhere ("EUR 47 heating bill" hits equally hard in Munich
              and Bucharest)

            ===============================================================
            AVAILABLE TOOLS (use ONLY these)
            ===============================================================
            You have ONLY these tools: Read, Write, Edit, Glob, Grep,
            WebSearch, WebFetch.

            Bash, curl, shell commands are NOT available.

            ===============================================================
            PHASE 1 — READ ALL INSTRUCTIONS (mandatory, do not skip)
            ===============================================================

            1. Read claude_automation/CLAUDE.md — project rules and constraints
            2. Read claude_automation/docs/linkedin/LINKEDIN_SOUL.md — voice, writing rules,
               audience segments, format strategy, output format.
               CRITICAL: This file begins with "Learned Rules from Feedback" — hand-curated
               denied patterns with specific scores. These are NON-NEGOTIABLE. Read them first,
               internalize them, and never repeat a denied pattern.
            3. Read claude_automation/docs/linkedin/LINKEDIN_PLAYBOOK.md — platform strategy,
               algorithm signals, hook formulas, do's and don'ts

            4. *** MANDATORY — STUDY TOP 3 BEST AND TOP 3 WORST POSTS ***
               Read claude_automation/docs/linkedin/linkedin-past-posts.md — full past
               post data. You MUST study at minimum the top 3 best-performing posts AND
               the top 3 worst-performing posts. For each, understand WHY it succeeded
               or failed. What made the hook land? What data drove reactions? What killed it?
               You may read additional posts for broader patterns and reference.

               HARD RULE: You may draw INSPIRATION from past phrasing, hooks, and
               structures that worked — but you must always iterate, improve, and
               innovate on them. Never copy word-for-word. Every post must push
               forward: test new angles, sharpen what worked, evolve the voice.
               The goal is continuous improvement, not repetition.

            5. Read claude_automation/docs/company/biobuilds-company-overview.md — company data,
               products, certifications, milestones, technical specs
            6. Read claude_automation/.agents/skills/seo-audit/references/ai-writing-detection.md
            7. If creatives are available, read claude_automation/Creatives/CATALOG.md for
               descriptions and metadata about each file

            ===============================================================
            PHASE 2 — CHECK EXISTING POSTS (avoid duplication)
            ===============================================================

            8. List all files in claude_automation/output/linkedin/ directory
            9. Read the last 5 LinkedIn posts (if they exist) and extract:
               - What topics were already covered
               - What audience segments were targeted
               - What hook styles were used
               - What pillar each post targeted
            10. Make sure your post covers NEW ground with a DIFFERENT angle

            ===============================================================
            PHASE 3 — RESEARCH (get real, current data across markets)
            ===============================================================

            11. Use WebSearch to find 2-3 current data points relevant to
                this week's pillar. Search for data that spans markets:
                - European energy prices or housing trends
                - Passivhaus certification stats or industry news
                - KfW funding rates (DACH angle)
                - Romanian/Eastern European construction developments
                - Modular construction or sustainability trends EU-wide
            12. Find data that resonates across all 3 markets

            ===============================================================
            PHASE 4 — MATCH CREATIVE (if available)
            ===============================================================

            13. If claude_automation/Creatives/ has files, read claude_automation/Creatives/CATALOG.md and use the
                descriptions and status to pick the best match for this week's
                pillar and today's topic.
                ONLY pick creatives that LinkedIn hasn't already used.
                OK to pick: [available], [USED ON INSTA], [REQUEST USE INSTA]
                Skip: [reserved], [USED ON LINKEDIN], [USED ON BOTH], [REQUEST USE LINKEDIN]
                A creative used on Instagram can still be used on LinkedIn.
            14. If you pick a creative from the catalog, set the frontmatter
                field creative_status to "REQUEST USE LINKEDIN" and explain
                in the post file why you chose it.
            15. If no creatives match or none exist, provide a photo_prompt
                or carousel_prompt describing the ideal visual instead.

            ===============================================================
            PHASE 5 — WRITE THE POST (English, all markets)
            ===============================================================

            16. Pick ONE primary audience segment but ensure cross-market appeal
            17. Choose a format: text, carousel description, or video concept
            18. Write the full LinkedIn post IN ENGLISH following ALL rules
                in LINKEDIN_SOUL.md:
                - Hook in first 210 characters with a specific number or tension
                - 800-1,200 characters for text posts
                - At least 3-5 specific data points with numbers
                - Include data from multiple markets (DACH + RO + international)
                - Data-first, emotion-grounded-in-specifics style
                - Maximum 3 hashtags
                - Close with discussion prompt, NOT a CTA
                - NO AI writing tells
                - NO broetry, no "let that sink in", no emoji formatting
            19. Include creative_file or carousel_prompt or photo_prompt.
                If using a catalog creative, set:
                  creative_file: "claude_automation/Creatives/filename.jpg"
                  creative_status: "REQUEST USE LINKEDIN"
                If no catalog match, provide photo_prompt/carousel_prompt only.
            20. Save to claude_automation/output/linkedin/ as:
                ${{ steps.date.outputs.today }}_[slug].md

            ===============================================================
            RULES (violations = failure)
            ===============================================================
            - NEVER frame BioBuilds as building offices or commercial spaces (we build HOMES)
            - NEVER use Bash, curl, or shell commands
            - NEVER run git commands
            - NEVER write like a LinkedIn influencer
            - NEVER use broetry or engagement bait
            - NEVER use more than 3 hashtags
            - NEVER put links in the post body
            - NEVER use AI-detectable writing patterns
            - ALWAYS write in English
            - ALWAYS include data relevant to multiple markets
            - ALWAYS include YAML frontmatter per LINKEDIN_SOUL.md
            - ALWAYS lead with a specific number or tension-creating statement
            - ALWAYS ground every claim in verifiable data
            - NEVER copy a past post word-for-word — inspire from what worked, then iterate and improve
            - Every post must push forward — test new angles, sharpen winners, evolve the voice

          claude_args: |
            --max-turns 35
            --model claude-opus-4-6
            --allowedTools "Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      # --- Commit directly to main -----------------------------------------
      - name: Check for changes
        id: changes
        run: |
          PATHS="output/linkedin/"
          [ -d "feedback/linkedin" ] && PATHS="$PATHS feedback/linkedin/"
          STATUS="$(git status --porcelain $PATHS)"
          if [ -z "$STATUS" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "::warning::No new LinkedIn post generated"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected:"
            echo "$STATUS"
          fi

      - name: Commit and push to main
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add output/linkedin/
          git add feedback/linkedin/ 2>/dev/null || true

          TODAY="${{ steps.date.outputs.today }}"
          PILLAR="${{ steps.pillar.outputs.pillar }}"

          git commit -m "linkedin: ${TODAY} [${PILLAR}]"

          # Pull-rebase in case another workflow pushed first, with retry
          for attempt in 1 2 3; do
            git pull --rebase origin ${{ github.event.repository.default_branch }} && \
            git push origin HEAD:${{ github.event.repository.default_branch }} && break
            echo "Push attempt $attempt failed, retrying in $((attempt * 2))s..."
            sleep $((attempt * 2))
          done
